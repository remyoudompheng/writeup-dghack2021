import socket
import time
from hashlib import sha256

from hash_based import _sequence, _main


def main():
    oracle = prepare()
    for item in oracle:
        print(item)

    # validate challenges
    for idx, c in enumerate(CHALLENGES):
        check = solve(bytes.fromhex(c), oracle)
        if check is None:
            print("FAIL")
            return
        answers = ANSWERS[idx].strip().split()
        for x, y in zip(check, answers):
            if x.hex() != y:
                print("Failed check challenge[%d] at seq %d", idx, i)
                return
        # compute public key
        digest = sha256(bytes.fromhex(c)).hexdigest()
        seq = _sequence(digest)
        invseq = [(256 - e) for e in seq]
        pk = _main(answers, invseq)
        if ''.join(pk) != PK:
            print("PK check fail")

    # ok, let's go
    for i in range(1000):
        print("Try", i)
        s = socket.create_connection(("hashsig.chall.malicecyber.com", 4998))
        s.sendall(b"c")
        print(s.recv(64))
        s.sendall(b"admin")
        chall = s.recv(64)
        print(chall.hex())
        z = solve(chall, oracle)
        if not z:
            print("FAIL")
            time.sleep(0.05)
            continue
        print("SUCCESS", chall.hex())
        # must be send in 1 packet
        for item in z:
            print(item.hex())
        s.sendall(b''.join(z))
        print("Response", s.recv(64))
        s.sendall(b"g")
        print(s.recv(1024))
        break

def solve(chall, oracle):
    digest = sha256(chall).hexdigest()
    seq = _sequence(digest)
    # compute
    res = []
    for idx, ((i, seed), j) in enumerate(zip(oracle, seq)):
        if j < i:
            print("Cannot solve", chall.hex(), "(at [%d] %d < %d)" % (idx,j,i))
            return None
        else:
            x = bytes.fromhex(seed)
            for _ in range(i, j):
                x = sha256(x).digest()
            res.append(x)
    return res

def prepare():
    seqs = []
    for i, c in enumerate(CHALLENGES):
        digest = sha256(bytes.fromhex(c)).hexdigest()
        seq = _sequence(digest)
        answers = ANSWERS[i].strip().split()
        seqs.append(list(zip(seq, answers)))

    return [min(s[i] for s in seqs) for i in range(34)]

# Computed from answer 1
PK = "3dd52cd580fca576bfe3201ca71a6e5ab238aff3d1b2304c4c555df7b89ddd9aaded445999f12cea6becc152e2b16dacac47d59307e14d5988d7f9015835e7d1cee5fba483860fc7c6154e6e18958b4d686964bfa77a243688ce1b89da4a0287a6109c4e91263eef31f140f0ed7d0cedb3859764e9be25079b0ffb59e67c220b8abe2dfef41b1159c424b586d963c46ab3af627cdd9d91f6550fe0b0e7a5ff02b007fe1a067012d3d3ca7e62a3a1d4f776fc8550bde9e3a9960b47c81ccdc85b03b740063d97e027a1661ef1fdd45d937f9316645fcae81dfb7fc2b4f9ae56f8878597c2cd6437ff88827a0fa5cc51ece61ec3b6f9e54c986033f3038089b08139cba98d7e0b7f08a2ceabb9019e8df2f898167a17e02b315768e3b2aa01996308263c1b33cc9fc033ee621d4e00dae0b26d29502e98bd2beae9fbd4adf6afcdb6d6df257424bdc36f38c7dd284ed315068bbf1f669bec722d4ecf873288f05db816d55aec77def05320fb8185dff55a6510bf1d31324fad5bfaf3569695546ae5b0956ea3303f7bc7292e7e5eb6326e5011f81a623ddc73a627225cd09459ec01f5c4136ee25352aa8ba392019c7151d0bb3139c759bba38d4490552fcd3a4724438f4f648b49c1489211fff8e3fdfacc06bd96f817bdb4e4b422656675be794a40198e278da57c4c5fb40fe75a23bb66e55d1125e8a790db4d69ded016cdec00715d6784bad02b9cc636bb6df82f7f1d23a1900ebd370554ebac71c6761ee6a9a6b1d4650470e5032726899642e6596f996b672504138890e5d2557133d0400dcecfcc701988eee9585001278b302f51aac02abc2513d2b17dddb74c58d3db6eac3aef543a2adffdf0abf64acebc9520d411a06f45d29a59a588d97fcebbb984a60f4affe6fc1f0fcd7ac092bcc02b83d01503c58be63d5b8dcd2523ee01bcb5ab4987845c81b09cd65cf7da7d8f12cde44d38c27e9c136f4ad18d7ba3c873603efa0c57cfc8fbed2eebabe38e3cdc5860f23f630f8b518a6abfd8eadf87bb18dbcc61ad961f1a90544ab660962bf25f8e960657f52537f01782141f7a98d1676d23430ff2f4ade1c6991372b3134e7671d0c6ff733cfe73a4a7eb00b3a8d3cbcd519572a84521a2b58bfcdf2cd9ca42472008c7bff38dc41739bfc4319ced6b0688abdf0e2c212c6c399225702891038dc37564cb99b6361198de01f41d260b00b65d15435acb9f4f1885fdfe12a98ea2821b15aac99a8edad5206443b48a3331ddba162a4194e71f6414167ec0ebc6c241e381c09a266e15f2d02c1147a0513300a3d6c0dc76cd1782c01c05210220ed9d7509d776e6fbe1e7ae40f97101e02aec5c391415ae4a477dce5bd6aded2e4623a69adae9b0ef06ecdf7c838539d9c65c0152da7649658d44c7b27fa36cc4efeb005bee13954f6d35337607bca643b0726a75dc604a956b357282708a2c399a5c86cad51cb2f059de571185f24e37ac74e9113b643466a3d04a92d67a1bbaffe203c07efe393ca52f5d0327c735"

CHALLENGES = [
    "51dccd2a76757ed416c2475f630aac1b1ae0b0a754e196223fd13d68c3b8b5df",
    "b66158d1852d75d6e62c90f0b43bd1ea519c3c36cbe9b60d9590bd041a014c62",
    "8a5a253cad5b50a4f6d6820c89f6013a9ac7c9e0d02f90da337fe4c4a1373367",
    "f8d742ecea0699d56a3599eaa87c68d1c2a0d117ad4ab1ff8afdb2bba99e810c",
    "6c556a795e614569fb1b61acb500fe82965a8fab998306beee99e221e80cb4ff",
]

ANSWERS = [
    """
de0fa2c1b4b49bce4a2a53b7301e2cb70239aeab336b7d7296e5d4cda2b63907
102e960c65f207f1cd5a42aca37912f8ccb3e7a36cea0dce13c1aced5f7e69d1
0462a2599b1072a128137b07489c37dc8ebd859068a0f1ddbc5545fb212ee81f
3899f0abc70fc8d03c82c16383be5bafe7ecab055245e6de46b7b8dee103bee4
70e15aab8998cb8c5d37e0565dd80e8cdde15d3d99bd058c50113ad32698f4f3
3642c555dd1bdc13415a693bcc2a9c1e1ed97039b1f31f4455b98fe8e652da0c
473881072f5bb66c726633b0bcfd431d46bb2bbac3a1a53d49d431cd885a0c48
98aae6dd18cccf45925e431efb4f48e1dd5ac21a17f8fbf88471b6f03c148c79
95d25c7aa28f913fbbbdb177f0dede916dfecd882f044cecd1d06a98b4cd64c5
78cb6a38db84d72628e97765071b01d3c1aec047c13712dbde56f1f1ac996f86
3e2b42caa936109e3ef7e9a4b03734034f978439af9303662a8684427c190907
639651a5538ffa13690d2be0916b038b84e4812b495a0f63ee8033bee58270a0
b6df06f98a4e52c23a5d43801cc66d7d5ea3ccf64426b6a7ff22022123fddb05
65747a429356b37195046034568c9a5b8326d0543cb6bca4505ad4067692640e
9eb281aad18a99f13d4dc1dd37a61268cbdfb80ed81a9b3dca71e2070b18f5a5
44d4d101badaf9826a4448438bb0b97f547615095bfc4bd7591ca53bca411d1b
46112a8254668e3af4d876c1e604e8dd637cab16da0c3b892dd6cbbb52529d5b
dcdd99b10f02a1b2614c6ce90f754170cf0c7cd5d39c4e9c4a0dc7393643553c
6d74b68cb0fe2a8266313aa3fed523d8fb4ed587d655b0ea4c28ec2d50d68937
00829c5f157e09ce72ff73d512dfb83e99762c80c2e5a5b443cbf48120454fc0
81a9289fa801900818ef28c72f5650a399fbc59156127335886f9617e2c64ac4
d210fd20b416aa2f01a839566aa1b95fbd17aef10142770b12114c5546082268
33a2cd0ea7217fc5231e4fd6c36f004e259cee8478cf20ded30dc2b2db63b0f9
1b57bac59cf2a1398360d6e1c99fbc2f5df9c3d7d9a40d179b6c37460a758605
c6af8ce6ae01b2a159e3e069ac003b8156b37888626057ad1fa98bf4c343e707
f452bf68340fd97db8b5e7312f4ebc2fa2ab55b354d5adeac2f0c3a87cb89e3e
13b146f18b8874d537e176928b1eb6ebb7d7aeb075332527249a88e7954da9c1
7551a6c1f84af0eb821020b8d87f5c73a0b1d9ddde620a31de5380c25c9fdf5e
a382ea5e4228d2ab8dd80505b773b18834aa32eb1f999007435f676da4b2e0ae
01b3c0675fb2e5a3ec7bf91cf22be8031871fc8bcedaef9ba0cbf84d93a5d4e4
0891d6ac8be326bed6f72b9040e164e56be6d3566093c69498e4e8e78e895231
959d9edb341874352b09d5484cd02d1b0a72530db516c474d802a7be2f67d1eb
91d83aabec5e3df34c569e6db418e140f93604b8c9631f5303fd5de845bca821
4f61b3f1170aa10d4fd17b791677114d1c07723ae8d9aaf7705a47f7d1133a32
""",
    """
0f892c0301604f83b943d3557c61057840960f1c72f73da69fd14d3baa029bd6
98ca338dd9adbbda1f5eeb5bba3825b7cba9fec876522213c3ee2885d146d24b
3ac932a5425824d6bcf7f6579706b358146720e9a8f9a6703908e1c7c1e3c6e8
ffcdad7bfd002ea9f3ba580849c6b7cdc892b7afed0c298c0c39203b8fbe438c
f89fd866538e10003f4b078d56fd0ab3e0b4793066bfe1a038d682d91d936ad9
4801a749516d914b01ccb2b8d476ed19b2bee677e3d9f099c302608e3e1e59cd
a1702118237523aa50f8abdfd7a0812fc92e32c732e35398b0ec7789ca37afb1
ab9bd416a4a4c72a7e621181ecb80447d194526427dd7ba5e597774adbbac106
081868213ff226049937df44fc714c5b91a711a27f8e201a9772b748579408c3
4a182eb22b3d257115fae9a45ccc85b3d5af6e8ebeda8a6aa6dfb9228717d1a6
2b059014d7991ded41fdacefa4a3d6ff75b190cdf155161e8bccd4a72ebc4dfd
b5d7f68d14ee0c40bc2e91ea00c9cfe5bfc4bc78f168fd1d1ee74ee58712117d
73fb550f1f48bf1195f5036e11c7531c32a8107c035acd197f084dae4f66c48c
8d5076962d991579901354cfe11577add54915696da1b73632f99ce6256481ac
b8abf2ec996c3245ed4589d3f28514bd9ab85e8c04666c4762693f51073b2df8
9b7fadfb22b21873e476e1be0db62068689d83a85e71b4ef48133c1d2a47b2ea
499b5a3ddd4e6eadbb208066c9bba3171aacf1e107b4f699bb9f9dc9c0211535
0dc58223ec08722bf48e6bdb9615ef167e92ac68bf43efbe1f7914cb2310ce08
def0aa66d8a70f3b6ff7c184d12f644232f6fa7fcd199a324e6ad9ad11b71303
0c8ad40869bfd46828f1b6839461f02c4892d608d01d3e83c75a5021429942df
d2cb41b96e835e122674fd86f9b88a1afbe153a444a9487841f26def568f99bb
47e8a763e2a9f2e63be1a61833d28b7f8847f7ff219143468640e72060b01d0d
45453307c98a5806f11a162740b1935000bcd8cefb7873a56a326c6116abd3e5
3fffb262c88536002115591f1511c73665fa9368991a9275488f221fdf844e2d
ab1fd27c49db8c7fbb72a34ff977ed71ea9b1f7bf38a569914a179ae067ba4d3
c047ac725af02032500616018e2bb35f6b3a4f8cea8017449996cb2c044d2417
78a344ec1604aa39087f78671c41f020f69b8c9a1e6ad14d34c44d56285c6433
d0e310ee720ba60fd6c4c0242ef01499b30a764f3dc4e50f1910a3b6209819dd
dc5d84b68434f421685b40f913ebecd4847f2a457279c5d19f7ac84f48a45e43
4a282cf778bd2a4cffe45ac97d60fac95a67acbd6bd46b8ac0eb97fb04f34710
02153a8b39695ceb8c7a1bc5f7e53a2d4bc22505b1146ad453db4004860701e0
33df042fd8f30fda07bd0071c037d812f763945176defe70dd1634767c0e13b0
60c34ab3f9c988ae2cc4caaa5ef7a20761d29b0aa99b3baca26d913c550a8609
fdd429b84e676ffed70f021d81821ccbe963bc626f4a530e04bef1b446e32615
""",
"""
859235209668766eaa014b00ebba6fded69404ecf70d668ffea316e86c7e0442
d2f622b30e2a5e6e46756875888686c6cb924d5ef0e87252e1432746d17ec754
76b867a85e23728f606b1b5edb6bbd44d27f34d7cac4e17c3aad514b7084be9e
bc80f9a694ba7a3d1e275992821d579b415d117f1ee9efd08c22eef752ca9094
dcba679ffa4ad8425ff08e99607ed1b0615569042e1b66cff13678b3264695d4
1ef34e07a68382f2c9dd1aa4d199fa0308d08512b7f99b78b031802ec9443d22
ad5dce27e5398ee59ed6545353700197a076f09b90ff9723cc169a75438ec287
cbf7c5d25d124e67a0ce24b777995663b44934de9705dca9f7fdc5da3ef2ffec
8f0a0456b3c3d16686a5565a114a527dc815ff1c2bc7471c9299db1b921e89cf
a051d85c0cf4c52e9dc71a98dd6ed2468f2feaa39f1b0e606bdb39a7e9350efd
50f164a0a9a0a3d78c6701e01346a5c8748113d7677c51b0df14b7ace8c7485e
b5d7f68d14ee0c40bc2e91ea00c9cfe5bfc4bc78f168fd1d1ee74ee58712117d
79da08680cac547cf87dc3ff27931e68c7c60347a5d2273e40860ccba130b3fa
d071f41c6520e4396fbd9919dce274e90262475db045a0168ceaf531c3a609a1
41fe5c49c2d0128c84d8dd8bc9b533a2d0eec207cbbf733944cd98130800036d
c34ecfcdd2cb26ca982a90e497e7a369cff1f60635e6254bd73ac25db7bd5680
99c3e56ef6dd3282b7548f65b208982de27d3cc8f2bb7e5ff04ce1d47f7630cd
b2750d063e23e4f6bca5d70c03fa63a0e30ed8f8aace0e55cb9046c223cd3c81
108a1dea0e7256c0013e5944aca8621da20fdd2b35bf9a770c40c742575cf00a
c2626c1786bf06f506c73ebbbb809f6ad9e928922010963fe837aff4a794b071
90e724f957aa19bb691139dd7484c36b4b874820c5bf64c4805e7f0aad37c41b
86ce5a6a6bb046ee728d806af6dd7ec06b63b8d8c750e07f31fff745aa1d852d
a38290deecdfdd07ba69fc9ebb6e5a974980f0bafb2b40a84e477a2615f888f7
9c4afbede31c9f98c042fed8e53dae72f252bab739844f313ab096be711e9f18
26eadcf52d558ab4b34695fdfbf71d8dad8655d38b5f6344a8f5a14bb0b45b19
a74b18e3801af3bcf101b23df5c24167347024c55a4bfad2a53b11aa41442e73
139be9b41d6d6b63e791d58bddd68ad2cd0bed00e3d364571c377620690bf062
13ea2b3c114d255b9de4dffed31b96efb477d0a5058a6849f2edf6c424589687
d05d2a8fefbdf72471d5f1f94c365db23f049e4a8b956448835cefa99744b678
39ec27ca99f15c883482f74d83e096b9bd61ad16c1e4269e35174a9182386ca5
90750e591554d997d29a356e06ddcd333fcefc715bb00767d5343e635edc497f
4cc3b448c822746410da03bc0e0a98dc110fcc0d76aea2671adc5fb5236fdd76
bc37f10399e86ce431cfd0e7b13faaae68ff0cd9cc6ef6f048c3a8e22719665f
779035dfff12c7064ef92143f7c626426027b2b31e2cfb37453fb69596212df8
""",
    """
7599049a79972b1f3c5f9cc30f67d09f6ebc14ef1e2283121d79bacdc4e5e54b
87e2fb04bda41e434ce76ed613f2ff7f6cb29c96509bee15d2fe4d329a1f2559
a6e8addd8c2b188a0b1191619d96f99d0e71d5642a7d548580948d5f9204070a
e8a0b2aec7714e234c0df324f7e8c23fb7d58dad8c596dcabd2b83bd5ecf7ee3
fea7a3324a033fd0edc085446af3884c13a2bc59b0fa683fa3f3e0eff40a2c9a
df8aff3ef4513f0f1ec6cfd864a51f66518608818aa503e1445733887731a188
e27f6643afd9515e574a9666a8b886d30b727a770e3c01bee0bb544c4cefd5f4
96bac3c70d6f2be538dbc0f899e55ada287c07eec8652dfacf6f7137f8c1c724
0a62c9236bb9e59763d71a1d8c0038b0f8eeb250a1a0123c1c115a5ff4b2d9b6
fc25d01134e5b11fb958eae7e4f7bd2dd8abe466b19768048bd34fca2e34acbd
11d3ff2e4f27cd1a39dfed5e35a9daddada20e93dbbed7cda6965857951c63a3
8a6810fc7bbc474643db9ab7295191a0252b047ac01607b1c8379129e7becacc
a969d7b5a80c7a32dd6ddfa6382560b40888b1381782e45fb4b4c32307d850df
4469ba2dece48e3b78892728f0197f1a898be482b55bc4c6047e7a9fad8cf94b
7fcdd01a37b810426d4808fbaa7ecf562b9a796e88a9bf97be43f2ae66abb2ac
71ccc13e1f98c5f020f4cf57d1e920085a1cba729ccef9acfea71dfb3f81da7d
67ec027e0f45c27195ad9979e06685f4e2b06fea4cbd1132aa3d5b4528af7d0e
b3ec6ed26594f87ab53ab61b131b1b6ced53f65c2788d79f66f37c616c4c0c3a
bdd52a4654359b047a4caa148285c775934c0dfd884f8ee7f21ca606ff0777cd
2a26f799ecc1865359173075e451a76dd6461c5f2141ae83e9531d824c8ed216
e80d6187f0138023b94ccef65caf8c948e344534b4069fece83d93582d7828bd
5a0dc4d99009cbabd31c1e82cf79fca22ac7ebadbbe1d2b601d7178a34f99ac6
1bafe3f6e2b081e3a5a1726df441905638440d2872c1835fbfcaa0e5bbc0054f
a25edcf1256bbb312fb0bbe419a85de29df69032859120ea444f396d2eed136a
ce3e34f5ca830576472048f7a2c709c9546429b5cc75ed259ee0697d5f175af5
ae351b5ff3abdb4f71e78005313d680c831f7c8ff05c14cddc26d6fb4ad80a67
20cf1cd1938fe71f6fd4bcc71cda2ed7cdf6b6b792f91d25c36b80acadcfb643
6d46dd6ed413b60873a7cd7a23927d0ab656257b0dd134e4f812c146dcd17e68
ec0ff78fceec49dbfb45db861a561c100678ca68be00b912df9df3680f216e91
b25301a2f92ceff1282a85e0825a0f02d05384f5a7dbb8bc17fcbc4c96b8e67e
6423abba2bc9643498deda344dd5b6865634d481e5e312e4d1a2489bebccadf6
dd3bde12737925493c5493389a3e79e56495013cbf0aebc4d5f836134119ddc6
580aa555892d0c93a64e571bd4f39c20d720fc7cabf04ca7653d6a83adbedb94
df4ad46605bdbc172f417015fbd8cd6402f4ac3d7abf55222ac759fc3888854b
""",
    """
1322e6ac9c21bd93cce046b5ca1cd5832d8f71d3c2308fc5f64ddecd59b05d71
ef93d7cfa83f4f73dc32b3bfe6004962cc1bdb69233d5cc3f8424ed4fcf6892f
ad6730aab296031505fd0d54ba05973fe917298e5de6def434399d3ea2ad6a97
caf4570cfcf89c02af237da482f87ecdc2565af01b296612faced38cda3ff040
22d4e66ddd08b7026c0ab12bc072dbbb7dc5dd850d14f19e3ee28c5fe481f2d4
8209b93911c309528d904177b43930e9dca48040417bd1d713bf8fdc6b46220c
3ad1ef9f8c7f52aed0920886a129981d3d930135a01e473c838bfd47544e002e
5816f1665327d4ffebc76ce6b8a81756227f1f4ed924df72b13edd3719df89ad
461ee175ecaea51c47625c86b531bbd8225ddc8350677877264283bd4411f5b1
6e92835ef9163b821e6a354ece850310fe228d0464b029ac8c80717a5ac45a96
a49e76187e88a825a51095c9e0803ed7f298632cb3559165c07d15cddc08461b
432dde857fbb03933527e5ddc287c8248a16c80d2ac1bc1a0c0eda7e153b971a
cf7bf968d049a6c13004fde80d47915f5dbca092586cfcbfcee6f4dbd9075dad
64e6b37d7ccfac7cd18c01a40a34ce711476e217e9b2d65923cbdcc9c7003684
4e9f2624af0eff20e0cc3a464ca8e080a1b85cb6bf305f24c9e9123bb3334e63
ea0cd7abb4569ea1c217692bed35e4e8e423202b4290d103406a5833bfa561b4
29f15b05a29c67e3a8196038cd83565e1157be8b80ab4f1d0b38a15f019b5ecc
71b516b2dddfc1f9caf333775dad678894d5bce227c7b39a1da514e6657f6824
7a01f1064a466b13b7aa58ec7dbeeaf7ae79abe789e9747af52898027dbb8e60
1f18d3624726828875b1ed714b2f04ba1f5448233f3813a7741b2c0226af16c7
cbb5efa49c0b1649014afff05557c159e9cdbc873a349038129b2a31fa8210d6
4e5f1bdbe905d0dca4528b68be9b0c67bb88463982492f3991489e4738443076
17d16084e6bffb5180fe045be176391b47eeb30089373836f889982c13319718
b6f378bab1d14e4ae0093905c1d0511ba8da616dd20b29c395eadc0f8eda9236
9898339ba916edc188dd8efbf2412ad53a996f9e5febf361bad73833cfe348b9
5ae1d4124ce5dc6a734446a45fbf23396e2559c6a06d50f286a01ee589476ca3
7c4b7abed1053e3d7fb29a234779d3024970b6060ffd6d76b44b3da0de9cc90d
a59ae3354b3bc7c7861849dcf095a6ccb9e4e4a4ff0d828650a8ba0b44924f52
d6ca82bc46b9fd007bda66226544cf2826e984fb9f5475d25a65a6f045db7638
c7012deb4f7af394ec388eb88d3da74329d3626d1ea75bd40edb106c9f9821ed
c9c5b65f8060b57b6b44e2e33ec31bf913b607e4408484cbf18c32628588c259
b22c061a34334aea7cd17ae185289835a6833a3fb433961a6a4a194b4207cf7a
6570ed9c9a57f9eeaad0570b889c3c9a82591d621859cb83b38b2df000ba43b3
fea9113d2fbdec41460991864df26441381a87c56eba01bc007bc11b2f581698
""",
]

if __name__ == "__main__":
    main()
